-- Ensure all required vulnerability columns exist
-- This migration ensures consistency between the database schema and application code

-- Ensure cvss_score column exists (for OSV.dev CVSS scores)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'cvss_score'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN cvss_score NUMERIC;
  END IF;
END $$;

-- Ensure nvd_score column exists (for NVD enrichment)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'nvd_score'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN nvd_score NUMERIC;
  END IF;
END $$;

-- Ensure nvd_severity column exists
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'nvd_severity'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN nvd_severity TEXT;
  END IF;
END $$;

-- Ensure source column exists
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'source'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN source TEXT DEFAULT 'OSV';
  END IF;
END $$;

-- Ensure discovered_at column exists
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'discovered_at'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN discovered_at TIMESTAMPTZ DEFAULT NOW();
  END IF;
END $$;

-- Ensure fixed_at column exists
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM information_schema.columns
    WHERE table_name = 'vulnerabilities' AND column_name = 'fixed_at'
  ) THEN
    ALTER TABLE vulnerabilities ADD COLUMN fixed_at TIMESTAMPTZ;
  END IF;
END $$;

-- Add helpful comments
COMMENT ON COLUMN vulnerabilities.cvss_score IS 'CVSS score from OSV.dev (primary vulnerability source)';
COMMENT ON COLUMN vulnerabilities.nvd_score IS 'CVSS score from NVD enrichment (optional, more authoritative)';
COMMENT ON COLUMN vulnerabilities.nvd_severity IS 'Severity rating from NVD enrichment';
COMMENT ON COLUMN vulnerabilities.source IS 'Source of vulnerability data: OSV, NVD Verified, etc.';
