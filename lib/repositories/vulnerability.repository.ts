import type { SupabaseClient } from "@supabase/supabase-js"
import type { Vulnerability, CreateVulnerabilityInput, UpdateVulnerabilityInput } from "../models/vulnerability"

export class VulnerabilityRepository {
  constructor(private supabase: SupabaseClient) {}

  async findById(id: string): Promise<Vulnerability | null> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("id", id)
      .single()

    if (error) return null
    return data as Vulnerability
  }

  async findByComponentId(componentId: string): Promise<Vulnerability[]> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("component_id", componentId)

    if (error) return []
    return data as Vulnerability[]
  }

  async findByCveId(cveId: string): Promise<Vulnerability | null> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("cve_id", cveId)
      .order("discovered_at", { ascending: false })
      .limit(1)
      .single()

    if (error) return null
    return data as Vulnerability
  }

  async create(input: CreateVulnerabilityInput): Promise<Vulnerability | null> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .insert(input)
      .select()
      .single()

    if (error) {
      console.error("[VulnerabilityRepo] Create error:", error)
      return null
    }
    return data as Vulnerability
  }

  async update(id: string, input: UpdateVulnerabilityInput): Promise<Vulnerability | null> {
    const { data, error} = await this.supabase
      .from("vulnerabilities")
      .update({
        ...input,
        updated_at: new Date().toISOString(),
      })
      .eq("id", id)
      .select()
      .single()

    if (error) {
      console.error("[VulnerabilityRepo] Update error:", error)
      return null
    }
    return data as Vulnerability
  }

  async updateStatus(
    id: string,
    status: "Open" | "Triaged" | "Patched" | "Ignored",
    notes?: string
  ): Promise<boolean> {
    const updateData: Record<string, unknown> = {
      status,
      updated_at: new Date().toISOString(),
    }
    if (notes) updateData.remediation_notes = notes

    const { error } = await this.supabase
      .from("vulnerabilities")
      .update(updateData)
      .eq("id", id)

    return !error
  }

  async patchVulnerabilitiesForComponent(componentId: string): Promise<number> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .update({ status: "Patched", updated_at: new Date().toISOString() })
      .eq("component_id", componentId)
      .in("status", ["Open", "Triaged"])
      .select()

    if (error) return 0
    return data?.length || 0
  }

  async enrichWithNvd(
    id: string,
    cvssScore: number,
    severity: string
  ): Promise<boolean> {
    const { error } = await this.supabase
      .from("vulnerabilities")
      .update({
        nvd_score: cvssScore,
        nvd_severity: severity,
        updated_at: new Date().toISOString(),
      })
      .eq("id", id)

    return !error
  }

  async autoIgnorePastDeadline(projectId: string): Promise<number> {
    const now = new Date().toISOString()

    // First, get all component IDs for this project
    const { data: components } = await this.supabase
      .from("sbom_components")
      .select("id")
      .eq("project_id", projectId)

    if (!components || components.length === 0) {
      return 0
    }

    const componentIds = components.map((c) => c.id)

    // Update vulnerabilities that are past deadline
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .update({
        status: "Ignored",
        remediation_notes: "Automatically ignored: deadline exceeded",
        updated_at: now,
      })
      .in("component_id", componentIds)
      .in("status", ["Open", "Triaged"])
      .lt("reporting_deadline", now)
      .select()

    if (error) {
      console.error("[VulnerabilityRepo] Auto-ignore error:", error)
      return 0
    }
    return data?.length || 0
  }
}
