import type { SupabaseClient } from "@supabase/supabase-js"
import type { Vulnerability, CreateVulnerabilityInput, UpdateVulnerabilityInput } from "../models/vulnerability"

export class VulnerabilityRepository {
  constructor(private supabase: SupabaseClient) {}

  async findById(id: string): Promise<Vulnerability | null> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("id", id)
      .single()

    if (error) return null
    return data as Vulnerability
  }

  async findByComponentId(componentId: string): Promise<Vulnerability[]> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("component_id", componentId)

    if (error) return []
    return data as Vulnerability[]
  }

  async findByCveId(cveId: string): Promise<Vulnerability | null> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .select("*")
      .eq("cve_id", cveId)
      .order("created_at", { ascending: false })
      .limit(1)
      .single()

    if (error) return null
    return data as Vulnerability
  }

  async create(input: CreateVulnerabilityInput): Promise<Vulnerability | null> {
    const now = new Date().toISOString()
    const reportingDeadline = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()

    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .insert({
        ...input,
        reporting_deadline: reportingDeadline,
        created_at: now,
        updated_at: now,
      })
      .select()
      .single()

    if (error) {
      console.error("[VulnerabilityRepo] Create error:", error)
      return null
    }
    return data as Vulnerability
  }

  async update(id: string, input: UpdateVulnerabilityInput): Promise<Vulnerability | null> {
    const { data, error} = await this.supabase
      .from("vulnerabilities")
      .update({
        ...input,
        updated_at: new Date().toISOString(),
      })
      .eq("id", id)
      .select()
      .single()

    if (error) {
      console.error("[VulnerabilityRepo] Update error:", error)
      return null
    }
    return data as Vulnerability
  }

  async updateStatus(
    id: string,
    status: "Open" | "Triaged" | "Patched" | "Ignored",
    notes?: string
  ): Promise<boolean> {
    const updateData: Record<string, unknown> = {
      status,
      updated_at: new Date().toISOString(),
    }
    if (notes) updateData.remediation_notes = notes

    const { error } = await this.supabase
      .from("vulnerabilities")
      .update(updateData)
      .eq("id", id)

    return !error
  }

  async patchVulnerabilitiesForComponent(componentId: string): Promise<number> {
    const { data, error } = await this.supabase
      .from("vulnerabilities")
      .update({ status: "Patched", updated_at: new Date().toISOString() })
      .eq("component_id", componentId)
      .in("status", ["Open", "Triaged"])
      .select()

    if (error) return 0
    return data?.length || 0
  }

  async enrichWithNvd(
    id: string,
    cvssScore: number,
    vector: string,
    description: string
  ): Promise<boolean> {
    const { error } = await this.supabase
      .from("vulnerabilities")
      .update({
        nvd_cvss_score: cvssScore,
        nvd_vector: vector,
        nvd_description: description,
        updated_at: new Date().toISOString(),
      })
      .eq("id", id)

    return !error
  }
}
