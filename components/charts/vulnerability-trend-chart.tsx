"use client"

import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from "recharts"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { format, subDays } from "date-fns"

interface VulnerabilityTrendChartProps {
    vulnerabilities: Array<{
        status: string
        discovered_at: string
        updated_at: string | null
    }>
}

export function VulnerabilityTrendChart({ vulnerabilities }: VulnerabilityTrendChartProps) {
    // Generate last 30 days of data
    const generateTrendData = () => {
        const days = 30
        const data = []
        const now = new Date()

        for (let i = days - 1; i >= 0; i--) {
            const date = subDays(now, i)
            const dateStr = format(date, "yyyy-MM-dd")

            // Count vulnerabilities discovered by this date
            const openCount = vulnerabilities.filter((v) => {
                const discovered = new Date(v.discovered_at)
                return discovered <= date && (v.status === "Open" || v.status === "Triaged")
            }).length

            const patchedCount = vulnerabilities.filter((v) => {
                const discovered = new Date(v.discovered_at)
                const updated = v.updated_at ? new Date(v.updated_at) : null
                return discovered <= date && updated && updated <= date && v.status === "Patched"
            }).length

            data.push({
                date: format(date, "MMM dd"),
                open: openCount,
                patched: patchedCount,
            })
        }

        return data
    }

    const data = generateTrendData()

    return (
        <Card className="border-border/60 bg-card/70">
            <CardHeader>
                <CardTitle className="text-xl font-semibold">Vulnerability Trends</CardTitle>
                <CardDescription>Last 30 days - Open vs Patched vulnerabilities</CardDescription>
            </CardHeader>
            <CardContent>
                <ResponsiveContainer width="100%" height={300}>
                    <AreaChart data={data} margin={{ top: 10, right: 30, left: 0, bottom: 0 }}>
                        <defs>
                            <linearGradient id="colorOpen" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="hsl(0 84% 60%)" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="hsl(0 84% 60%)" stopOpacity={0} />
                            </linearGradient>
                            <linearGradient id="colorPatched" x1="0" y1="0" x2="0" y2="1">
                                <stop offset="5%" stopColor="hsl(142 76% 36%)" stopOpacity={0.8} />
                                <stop offset="95%" stopColor="hsl(142 76% 36%)" stopOpacity={0} />
                            </linearGradient>
                        </defs>
                        <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
                        <XAxis
                            dataKey="date"
                            className="text-xs text-muted-foreground"
                            tick={{ fill: "hsl(var(--muted-foreground))" }}
                        />
                        <YAxis
                            className="text-xs text-muted-foreground"
                            tick={{ fill: "hsl(var(--muted-foreground))" }}
                        />
                        <Tooltip
                            contentStyle={{
                                backgroundColor: "hsl(var(--card))",
                                border: "1px solid hsl(var(--border))",
                                borderRadius: "var(--radius)",
                            }}
                        />
                        <Legend />
                        <Area
                            type="monotone"
                            dataKey="open"
                            stroke="hsl(0 84% 60%)"
                            fillOpacity={1}
                            fill="url(#colorOpen)"
                            name="Open"
                        />
                        <Area
                            type="monotone"
                            dataKey="patched"
                            stroke="hsl(142 76% 36%)"
                            fillOpacity={1}
                            fill="url(#colorPatched)"
                            name="Patched"
                        />
                    </AreaChart>
                </ResponsiveContainer>
            </CardContent>
        </Card>
    )
}
